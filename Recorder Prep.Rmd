---
title: "Recorder Prep"
author: "Sander"
date: "20 februari 2018"
output: html_document
---

```{r Clean enviroment}
rm(list = ls())
```

```{r Libraries}
library(tidyverse)
library(googlesheets)
```

```{r Read Data}
Recorder_Ruw <- read_csv("./Intermediate/Brondata.csv")
```

```{r Read Libs}
title <- gs_title(x="Locaties", verbose = TRUE)
Locaties <- gs_read(title)

Log <- read.csv("G://Mijn Drive/INBOPRJ-10217 - Monitoring exoten ikv EU- verordening IAS  CoÃ¶rdinatie, voorbereiding, implementatie en opvolging/Stierkikker/Opvolging beheer/Stierkikker data-analyse/Log.csv")
Log$X <- NULL

```
```{r Aantal fuiken juist zetten}
Recorder_Ruw$`Aantal fuiken (Totaal)` <- ifelse(is.na(Recorder_Ruw$`Aantal fuiken (Totaal)`), Recorder_Ruw$`Aantal fuiken geplaatst`, Recorder_Ruw$`Aantal fuiken (Totaal)`)
Recorder_Ruw$`Aantal fuiken (Totaal)` <- ifelse(is.na(Recorder_Ruw$`Aantal fuiken (Totaal)`), 0, Recorder_Ruw$`Aantal fuiken (Totaal)`)
Recorder_Ruw$`Aantal fuiken (Totaal)` <- as.numeric(Recorder_Ruw$`Aantal fuiken (Totaal)`)
summary(Recorder_Ruw$`Aantal fuiken (Totaal)`)
table(Recorder_Ruw$`Aantal fuiken (Totaal)`)
Recorder_Ruw <- subset(Recorder_Ruw, !is.na(Datum))
Recorder_Ruw <- subset(Recorder_Ruw, !is.na(`Aantal fuiken (Totaal)`))

####Foutieve NA in aantal fuiken corrigeren
Recorder_Ruw$`Aantal fuiken (Totaal)`[Recorder_Ruw$Tijdstempel == "8-8-2016 23:34:27"] <- 1
Recorder_Ruw$`Aantal fuiken (Totaal)`[Recorder_Ruw$Tijdstempel == "8-8-2016 23:36:05"] <- 1
Recorder_Ruw$`Aantal fuiken (Totaal)`[Recorder_Ruw$Tijdstempel == "8-8-2016 23:38:47"] <- 1
Recorder_Ruw$`Aantal fuiken (Totaal)`[Recorder_Ruw$Tijdstempel == "8-8-2016 23:40:20"] <- 1
gnFuiken <- subset(Recorder_Ruw, is.na(`Aantal fuiken (Totaal)`)|`Aantal fuiken (Totaal)`==0)

print(gnFuiken)
```

```{r Afvangsten vr Recorder}
Recorder_Afvangsten <- subset(Recorder_Ruw, Sample_Type == "Afvangst")
Locations_Recorder <- unique(Recorder_Afvangsten$Location)
#Wide -> Long
Recorder_Afvangsten %>% 
                    select(-contains("Bijvangst"), -contains("e-mail"), -contains("Locatie"), -contains("x"),                              -contains("y"), -contains("Aantal fuiken geplaatst"), -contains("vangstperiode"), -contains("Meer")) %>%
                    gather(key="Stadium", value="Aantal", c(-Tijdstempel, -Location, -Datum, -Startuur, -Einduur,                          -Recorder,-`Aantal fuiken (Totaal)`), -`Net verhoogd?`, -contains("Opmerkingen")) -> temp
                    

table(temp$Stadium)
table(temp$Location)
#Calculate total
temp %>% 
     group_by_at(vars("Location", "Datum")) %>%
     mutate(Totaal=sum(as.numeric(Aantal), na.rm = T)) %>%
     ungroup() -> temp2
#Subsets
Afvangsten <- subset(temp2, Totaal > 0)
Nulvangsten <- subset(temp2, Totaal == 0)
sum(nrow(Afvangsten), nrow(Nulvangsten)) == nrow(temp2) #Uitkomst moet TRUE zijn

#Afvangsten
Afvangsten <- subset(Afvangsten, !is.na(Aantal) & Aantal > 0)
Afvangsten$LocationName <- strtrim(Afvangsten$Stadium, 7)
Afvangsten$LocationName <- gsub(x = Afvangsten$LocationName, pattern = " +$", replacement =  "")
table(Afvangsten$LocationName)
Afvangsten$Stadium2 <- substr(Afvangsten$Stadium, nchar(Afvangsten$LocationName)+4, nchar(Afvangsten$Stadium))
table(Afvangsten$Stadium2)
Afvangsten2 <- data.frame(Afvangsten)
#Nulvangsten
Nulvangsten$LocationName <- strtrim(Nulvangsten$Stadium, 7)
Nulvangsten$LocationName <- gsub(x = Nulvangsten$LocationName, pattern = " +$", replacement =  "")
table(Nulvangsten$LocationName)
Nulvangsten$Fuiknr <- substr(Nulvangsten$LocationName, nchar("Fuik "), nchar(Nulvangsten$LocationName))
table(Nulvangsten$Fuiknr)
Nulvangsten2 <- subset(Nulvangsten, as.numeric(Fuiknr) <= as.numeric(`Aantal fuiken (Totaal)`))
Nulvangsten2 %>% 
  group_by_at(vars(Tijdstempel, Location, Datum, Startuur, Einduur, `Aantal fuiken (Totaal)`, `Net verhoogd?`, contains("Fuik"), Recorder, Aantal, LocationName, Totaal )) %>%
  summarise() -> temp3
Nulvangsten2 <- data.frame(temp3)
Nulvangsten2$Fuiknr <- NULL
Nulvangsten2$Stadium2 <- "None"
Nulvangsten2$Stadium <- "None"
#Bind Afvangsten and Nulvangsten
Recorder_Afvangsten_Long <- rbind(Afvangsten2, Nulvangsten2)
Recorder_Afvangsten_Long$Stadium <- NULL
Recorder_Afvangsten_Long$Totaal <- NULL
Recorder_Afvangsten_Long %>% rename(Stadium = Stadium2) -> Recorder_Afvangsten_Long

#Add xy to Afvangsten
Recorder_Afvangsten_Long_Loc <- merge(Recorder_Afvangsten_Long, Locaties, all.x = T)
table(Recorder_Afvangsten_Long_Loc$GridReference, useNA = "ifany")
Missing_Locaties <- subset(Recorder_Afvangsten_Long_Loc, is.na(GridReference))
table(Missing_Locaties$Location)

#Add species
```

