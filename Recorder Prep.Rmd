---
title: "Recorder Prep"
author: "Sander"
date: "20 februari 2018"
output: html_document
---

```{r Clean enviroment}
rm(list = ls())
```

```{r Libraries}
library(tidyverse)
library(googlesheets)
```

```{r Read Data}
Recorder_Ruw <- read_csv("./Intermediate/Brondata.csv")
```

```{r Read Libs}
title <- gs_title(x="Locaties", verbose = TRUE)
Locaties <- gs_read(title)

title <- gs_title(x="Bijvangst", verbose = TRUE)
Bijvangst <- gs_read(title)


Log <- read.csv("G://Mijn Drive/INBOPRJ-10217 - Monitoring exoten ikv EU- verordening IAS  CoÃ¶rdinatie, voorbereiding, implementatie en opvolging/Stierkikker/Opvolging beheer/Stierkikker data-analyse/Log.csv")
Log$X <- NULL

```
```{r Aantal fuiken juist zetten}
Recorder_Ruw$`Aantal fuiken (Totaal)` <- ifelse(is.na(Recorder_Ruw$`Aantal fuiken (Totaal)`), Recorder_Ruw$`Aantal fuiken geplaatst`, Recorder_Ruw$`Aantal fuiken (Totaal)`)
Recorder_Ruw$`Aantal fuiken (Totaal)` <- ifelse(is.na(Recorder_Ruw$`Aantal fuiken (Totaal)`), 0, Recorder_Ruw$`Aantal fuiken (Totaal)`)
Recorder_Ruw$`Aantal fuiken (Totaal)` <- as.numeric(Recorder_Ruw$`Aantal fuiken (Totaal)`)
summary(Recorder_Ruw$`Aantal fuiken (Totaal)`)
table(Recorder_Ruw$`Aantal fuiken (Totaal)`)
Recorder_Ruw <- subset(Recorder_Ruw, !is.na(Datum))
Recorder_Ruw <- subset(Recorder_Ruw, !is.na(`Aantal fuiken (Totaal)`))

####Foutieve NA in aantal fuiken corrigeren
Recorder_Ruw$`Aantal fuiken (Totaal)`[Recorder_Ruw$Tijdstempel == "8-8-2016 23:34:27"] <- 1
Recorder_Ruw$`Aantal fuiken (Totaal)`[Recorder_Ruw$Tijdstempel == "8-8-2016 23:36:05"] <- 1
Recorder_Ruw$`Aantal fuiken (Totaal)`[Recorder_Ruw$Tijdstempel == "8-8-2016 23:38:47"] <- 1
Recorder_Ruw$`Aantal fuiken (Totaal)`[Recorder_Ruw$Tijdstempel == "8-8-2016 23:40:20"] <- 1
gnFuiken <- subset(Recorder_Ruw, is.na(`Aantal fuiken (Totaal)`)|`Aantal fuiken (Totaal)`==0)

print(gnFuiken)
```

```{r Afvangsten vr Recorder}
Recorder_Afvangsten <- subset(Recorder_Ruw, Sample_Type == "Afvangst")
Locations_Recorder <- unique(Recorder_Afvangsten$Location)

#Wide -> Long
Recorder_Afvangsten %>% 
                    select(-contains("Bijvangst"), -contains("e-mail"), -contains("Locatie"), -contains("x"),                              -contains("y"), -contains("Aantal fuiken geplaatst"), -contains("vangstperiode"), -contains("Meer")) %>%
                    gather(key="Stadium", value="Aantal", c(-Tijdstempel, -Location, -Datum, -Startuur, -Einduur,                          -Recorder,-`Aantal fuiken (Totaal)`, -`Net verhoogd?`, -contains("Opmerkingen"))) -> temp
                    

table(temp$Stadium)
table(temp$Location)
#Calculate total
temp %>% 
     group_by_at(vars("Location", "Datum")) %>%
     mutate(Totaal=sum(as.numeric(Aantal), na.rm = T)) %>%
     ungroup() -> temp2
#Subsets
Afvangsten <- subset(temp2, Totaal > 0)
Nulvangsten <- subset(temp2, Totaal == 0)
sum(nrow(Afvangsten), nrow(Nulvangsten)) == nrow(temp2) #Uitkomst moet TRUE zijn

#Afvangsten
Afvangsten <- subset(Afvangsten, !is.na(Aantal) & Aantal > 0)
Afvangsten$LocationName <- strtrim(Afvangsten$Stadium, 7)
Afvangsten$LocationName <- gsub(x = Afvangsten$LocationName, pattern = " +$", replacement =  "")
table(Afvangsten$LocationName)
Afvangsten$Stadium2 <- substr(Afvangsten$Stadium, nchar(Afvangsten$LocationName)+4, nchar(Afvangsten$Stadium))
table(Afvangsten$Stadium2)
Afvangsten2 <- data.frame(Afvangsten)
#Nulvangsten
Nulvangsten$LocationName <- strtrim(Nulvangsten$Stadium, 7)
Nulvangsten$LocationName <- gsub(x = Nulvangsten$LocationName, pattern = " +$", replacement =  "")
table(Nulvangsten$LocationName)
Nulvangsten$Fuiknr <- substr(Nulvangsten$LocationName, nchar("Fuik "), nchar(Nulvangsten$LocationName))
table(Nulvangsten$Fuiknr)
Nulvangsten2 <- subset(Nulvangsten, as.numeric(Fuiknr) <= as.numeric(`Aantal fuiken (Totaal)`))
Nulvangsten2 %>% 
  group_by_at(vars(Tijdstempel, Location, Datum, Startuur, Einduur, `Aantal fuiken (Totaal)`, `Net verhoogd?`, contains("Fuik"), Recorder, Aantal, LocationName, Totaal )) %>%
  summarise() -> temp3
Nulvangsten2 <- data.frame(temp3)
Nulvangsten2$Fuiknr <- NULL
Nulvangsten2$Stadium2 <- "None"
Nulvangsten2$Stadium <- "None"
#Bind Afvangsten and Nulvangsten
Recorder_Afvangsten_Long <- rbind(Afvangsten2, Nulvangsten2)
Recorder_Afvangsten_Long$Stadium <- NULL
Recorder_Afvangsten_Long$Totaal <- NULL
Recorder_Afvangsten_Long %>% rename(Measurement_Qualifier = Stadium2) -> Recorder_Afvangsten_Long

#Add xy to Afvangsten
Recorder_Afvangsten_Long_Loc <- merge(Recorder_Afvangsten_Long, Locaties, all.x = T)
table(Recorder_Afvangsten_Long_Loc$GridReference, useNA = "ifany")
Missing_Locaties <- subset(Recorder_Afvangsten_Long_Loc, is.na(GridReference))
table(Missing_Locaties$Location)

#Add species to afvangsten
Recorder_Afvangsten_Long_Loc$Species <- "Lithobates catesbeianus"

#Add fixed values to Afvangsten
Recorder_Afvangsten_Long_Loc$Sample_Type <- ifelse(grepl(Recorder_Afvangsten_Long_Loc$Fuik.1...Opmerkingen, pattern = "bodemsalamander"), "Salamander Fuik Bodem", ifelse(grepl(Recorder_Afvangsten_Long_Loc$Fuik.1...Opmerkingen, pattern = "drijvend"), "Salamander Fuik Drijvend", "Schietfuik"))

Recorder_Afvangsten_Long_Loc$Measurement_Accuracy <- "Exact"

table(Recorder_Afvangsten_Long_Loc$Sample_Type, useNA = "ifany")

#Rename columns
Recorder_Afvangsten_Long_Loc %>% rename(`Aantal fuiken (Totaal)` = `Aantal.fuiken..Totaal.` ,  `Net verhoogd?` = `Net.verhoogd.`,`Fuik 1 - Opmerkingen` = `Fuik.1...Opmerkingen`, `Fuik 2 - Opmerkingen` = `Fuik.2...Opmerkingen` , `Fuik 3 - Opmerkingen` = `Fuik.3...Opmerkingen`, `Fuik 4 - Opmerkingen` = `Fuik.4...Opmerkingen`, `Fuik 5 - Opmerkingen` = `Fuik.5...Opmerkingen`, `Fuik 6 - Opmerkingen` = `Fuik.6...Opmerkingen`, `Fuik 7 - Opmerkingen` = `Fuik.7...Opmerkingen`, `Fuik 8 - Opmerkingen` = `Fuik.8...Opmerkingen`, `Fuik 9 - Opmerkingen` = `Fuik.9...Opmerkingen`, `Fuik 10 - Opmerkingen` = `Fuik.10...Opmerkingen`, `Fuik 11 - Opmerkingen` = `Fuik.11...Opmerkingen`, `Fuik 12 - Opmerkingen` = `Fuik.12...Opmerkingen`) -> Recorder_Afvangsten_Long_Loc_Renamed

#Delete unnecessary columns
Recorder_Afvangsten_Long_Loc_Renamed$Recorder_Status <- NULL

#Cleanup
Recorder_Afvangsten_Final <- Recorder_Afvangsten_Long_Loc_Renamed

remove(Recorder_Afvangsten_Long_Loc_Renamed)
remove(Recorder_Afvangsten_Long_Loc)
remove(Recorder_Afvangsten_Long)
```

###Create Bijvangsten 
```{r Subsets}
Recorder_Afvangsten %>% 
  unite(col=test, contains("Soort"), remove = F) %>%
  mutate(preapp = case_when(grepl(test, pattern = ".*\\[.*") ~ 0,
                            TRUE ~ 1)) -> Recorder_Bijvangsten
 
Recorder_Bijvangsten_gform <- subset(Recorder_Bijvangsten, preapp == 1) 
Recorder_Bijvangsten_app_raw <- subset(Recorder_Bijvangsten, preapp == 0)
sum(nrow(Recorder_Bijvangsten_gform), nrow(Recorder_Bijvangsten_app_raw)) == nrow(Recorder_Bijvangsten) #Moet TRUE zijn


```

```{r gfrom Bijvangsten}
#Wide -> Long
Recorder_Bijvangsten_gform %>% 
  select(-contains("L00"), -contains("L0"), -contains("L1"), -contains("L2"), -contains("M1"), -contains("M2"), -contains("AM"), -contains("AV"), -contains("e-mail"), -contains("Locatie"), -contains("x"), -contains("y"), -contains("Aantal fuiken geplaatst"), -contains("vangstperiode"), -contains("Meer"), -contains("test"), -contains("preapp")) %>%
  gather(key = "Soort_NL", value = "Measurement_Qualifier", c(-Tijdstempel, -Location, -Datum, -Startuur, -Einduur,                          -Recorder,-`Aantal fuiken (Totaal)`, -`Net verhoogd?`, -contains("Opmerkingen"))) %>%
  filter(!is.na(Measurement_Qualifier)) -> Recorder_Bijvangsten_gform_Long
  
#Add fixed values to gfrom
Recorder_Bijvangsten_gform_Long$Aantal <- 1
Recorder_Bijvangsten_gform_Long$Measurement_Accuracy <- "Estimate"
Recorder_Bijvangsten_gform_Long$Sample_Type <- ifelse(grepl(Recorder_Bijvangsten_gform_Long$`Fuik 1 - Opmerkingen`, pattern = "bodemsalamander"), "Salamander Fuik Bodem", ifelse(grepl(Recorder_Bijvangsten_gform_Long$`Fuik 1 - Opmerkingen`, pattern = "drijvend"), "Salamander Fuik Drijvend", "Schietfuik"))

table(Recorder_Bijvangsten_gform_Long$Soort_NL, Recorder_Bijvangsten_gform_Long$Aantal)
#Add locationname to gfrom
Recorder_Bijvangsten_gform_Long$LocationName <- strtrim(Recorder_Bijvangsten_gform_Long$Soort_NL, 7)
Recorder_Bijvangsten_gform_Long$LocationName <- gsub(x = Recorder_Bijvangsten_gform_Long$LocationName, pattern = " +$", replacement =  "")
table(Recorder_Bijvangsten_gform_Long$LocationName)

#Add species to gfrom
Recorder_Bijvangsten_gform_Long$Soort_NL2 <- substr(Recorder_Bijvangsten_gform_Long$Soort_NL, nchar("Fuik 1 Bijvangst[ ")+2, nchar(Recorder_Bijvangsten_gform_Long$Soort_NL))
table(Recorder_Bijvangsten_gform_Long$Soort_NL2)

Recorder_Bijvangsten_gform_Long_Soort <- merge(Recorder_Bijvangsten_gform_Long, Bijvangst, by.x = "Soort_NL2", by.y= "soort", all.x = T)

Nieuwe_Soorten <- subset(Recorder_Bijvangsten_gform_Long_Soort, is.na(Soort_Nieuw))
print(unique(Nieuwe_Soorten$Soort_NL2))

#Add xy to gform
Recorder_Bijvangsten_gform_Long_Soort_xy <- merge(Recorder_Bijvangsten_gform_Long_Soort, Locaties, all.x=T)

#Removed unnecessary columns
Recorder_Bijvangsten_gform_Long_Soort_xy$Soort_NL2 <- NULL
Recorder_Bijvangsten_gform_Long_Soort_xy$Recorder_Status <- NULL

#Cleanup
Recorder_Bijvangsten_gform_Final <- Recorder_Bijvangsten_gform_Long_Soort_xy

remove(Recorder_Bijvangsten_gform_Long_Soort_xy)
remove(Recorder_Bijvangsten_gform_Long_Soort)
remove(Recorder_Bijvangsten_gform_Long)
remove(Recorder_Bijvangsten_gform)
```

```{r app Bijvangsten}
Recorder_Bijvangsten_app <- Recorder_Bijvangsten_app_raw

b <- nrow(Bijvangst)

#Wide -> Long
Recorder_Bijvangsten_app %>% 
  separate(test, sep = "_", into = c("Fuik 1", "Fuik 2", "Fuik 3", "Fuik 4", "Fuik 5", "Fuik 6", "Fuik 7", "Fuik 8",      "Fuik 9", "Fuik 10", "Fuik 11", "Fuik 12")) %>% 
  select(-contains("L00"), -contains("L0"), -contains("L1"), -contains("L2"), -contains("M1"), -contains("M2"),           -contains("AM"), -contains("AV"), -contains("e-mail"), -contains("Locatie"), -contains("x"), -contains("y"),          -contains("Aantal fuiken geplaatst"), -contains("vangstperiode"), -contains("Meer"), -contains("preapp"),             -contains("Bijvangst")) %>%
  gather(key = "LocationName", value = "Soorten", c(-Tijdstempel, -Datum, -Startuur, -Einduur, 
                                                    -`Aantal fuiken (Totaal)`, -`Net verhoogd?`,                          -contains("Opmerkingen"), -Location, -Recorder)) %>%
  filter(Soorten != "NA") %>%
  separate(Soorten, sep = ";", into = c(paste("soort", 1:b)) ) %>%
  gather(key = "test", value = "Soort_NL", c(-Tijdstempel, -Datum, -Startuur, -Einduur, -`Aantal fuiken (Totaal)`,        -`Net verhoogd?`, -contains("Opmerkingen"), -Location, -Recorder, -LocationName)) %>%
  filter(!is.na(Soort_NL)) %>%
  select(-test)-> Recorder_Bijvangsten_app_Long

#Add fixed values
Recorder_Bijvangsten_app_Long$Aantal <- 1
Recorder_Bijvangsten_app_Long$Measurement_Accuracy <- "Estimate"
Recorder_Bijvangsten_app_Long$Sample_Type <- ifelse(grepl(Recorder_Bijvangsten_app_Long$`Fuik 1 - Opmerkingen`, pattern = "bodemsalamander"), "Salamander Fuik Bodem", ifelse(grepl(Recorder_Bijvangsten_app_Long$`Fuik 1 - Opmerkingen`, pattern = "drijvend"), "Salamander Fuik Drijvend", "Schietfuik"))

#Add species to gfrom
Recorder_Bijvangsten_app_Long_Soort <- merge(Recorder_Bijvangsten_app_Long, Bijvangst, by.x = "Soort_NL", by.y= "soort", all.x = T)

#Add xy to gform
Recorder_Bijvangsten_app_Long_Soort_xy <- merge(Recorder_Bijvangsten_app_Long, Locaties, all.x=T)

#Remove unnecessary columns
Recorder_Bijvangsten_app_Long_Soort_xy$Recorder_Status <- NULL

#Cleanup
Recorder_Bijvangsten_app_Final <- Recorder_Bijvangsten_app_Long_Soort_xy

remove(Recorder_Bijvangsten_app_Long_Soort_xy)
remove(Recorder_Bijvangsten_app_Long_Soort)
remove(Recorder_Bijvangsten_app_Long)
remove(Recorder_Bijvangsten_app)
```
#Merge subsets
```{r Merge subsets}
setdiff(x = Recorder_Afvangsten_Final, y = Recorder_Bijvangsten_gform_Final)

names(Recorder_Bijvangsten_app_Final)
names(Recorder_Bijvangsten_gform_Finaal)
names(Recorder_Afvangsten_Final)

Recorder_Afvangsten_Merged <- rbind(Recorder_Afvangsten_Final, Recorder_Bijvangsten_app_Final, Recorder_Bijvangsten_gform_Finaal, Nulvangsten2)
```

